---
import BaseLayout from '../../layouts/BaseLayout.astro';
import LinkCard from '../../components/LinkCard.astro';
import TagCloud from '../../components/TagCloud.astro';
import linksData from '../../data/links.json';

export function getStaticPaths() {
  // Get all unique tags
  const allTags = [...new Set(linksData.links.flatMap(link => link.tags))];
  
  return allTags.map(tag => ({
    params: { tag },
    props: { tag }
  }));
}

const { tag } = Astro.props;

// Get links with this tag
const taggedLinks = linksData.links
  .filter(link => link.tags.includes(tag))
  .sort((a, b) => new Date(b.dateShared).getTime() - new Date(a.dateShared).getTime());

// Calculate all tag counts for the sidebar
const tagCounts = new Map<string, number>();
linksData.links.forEach(link => {
  link.tags.forEach(t => {
    tagCounts.set(t, (tagCounts.get(t) || 0) + 1);
  });
});

const allTags = Array.from(tagCounts.entries())
  .map(([name, count]) => ({ name, count }))
  .sort((a, b) => b.count - a.count);
---

<BaseLayout title={`#${tag}`} description={`Links tagged with #${tag}`}>
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Header -->
    <div class="mb-10">
      <a 
        href="/links" 
        class="inline-flex items-center gap-2 text-[--color-terminal-green] font-mono mb-4 hover:text-[--color-terminal-green-light] transition-colors group"
      >
        <span class="group-hover:-translate-x-1 transition-transform">‚Üê</span>
        <span>All Links</span>
      </a>
      
      <h1 class="text-3xl sm:text-4xl font-bold text-[--color-terminal-green] text-glow mb-2 font-mono">
        <span class="mr-2">$</span>grep -l "#{tag}"
      </h1>
      <p class="text-[--color-text-dim] font-mono">
        {taggedLinks.length} {taggedLinks.length === 1 ? 'link' : 'links'} found
      </p>
      <div class="h-1 w-32 bg-[--color-terminal-green] mt-4"></div>
    </div>

    <div class="lg:grid lg:grid-cols-4 lg:gap-8">
      <!-- Main Content -->
      <div class="lg:col-span-3">
        <!-- Links Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          {taggedLinks.map((link) => (
            <LinkCard
              id={link.id}
              url={link.url}
              title={link.title}
              summary={link.summary}
              tags={link.tags}
              dateShared={link.dateShared}
              thumbnail={link.thumbnail}
            />
          ))}
        </div>

        {taggedLinks.length === 0 && (
          <div class="text-center py-16">
            <div class="text-6xl mb-4">üè∑Ô∏è</div>
            <h3 class="text-xl font-mono text-[--color-terminal-green] mb-2">No links with this tag</h3>
            <p class="text-[--color-text-dim]">Try browsing other tags</p>
          </div>
        )}
      </div>

      <!-- Sidebar -->
      <aside class="lg:col-span-1 mt-10 lg:mt-0">
        <div class="sticky top-24">
          <h2 class="text-lg font-mono text-[--color-terminal-green] mb-4">
            &gt; Other Tags_
          </h2>
          <div class="bg-[--color-bg-card] border border-[--color-terminal-green]/30 p-4">
            <div class="flex flex-wrap gap-2">
              {allTags.map((t) => (
                <a 
                  href={`/tags/${t.name}`}
                  class:list={[
                    "px-2 py-1 text-xs font-mono border transition-colors",
                    t.name === tag 
                      ? "bg-[--color-terminal-green] text-[--color-bg] border-[--color-terminal-green]"
                      : "text-[--color-terminal-green] border-[--color-terminal-green]/30 hover:border-[--color-terminal-green]"
                  ]}
                >
                  #{t.name}
                  <span class="ml-1 opacity-70">({t.count})</span>
                </a>
              ))}
            </div>
          </div>
        </div>
      </aside>
    </div>
  </section>
</BaseLayout>
