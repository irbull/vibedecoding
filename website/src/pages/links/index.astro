---
import BaseLayout from '../../layouts/BaseLayout.astro';
import LinkCard from '../../components/LinkCard.astro';
import SearchBar from '../../components/SearchBar.astro';
import linksData from '../../data/links.json';

// Get all links sorted by date
const allLinks = linksData.links.sort((a, b) => 
  new Date(b.dateShared).getTime() - new Date(a.dateShared).getTime()
);

// Get all unique tags
const allTags = [...new Set(allLinks.flatMap(link => link.tags))].sort();
---

<BaseLayout title="All Links" description="Browse all shared links">
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Header -->
    <div class="mb-10">
      <h1 class="text-3xl sm:text-4xl font-bold text-[--color-terminal-green] text-glow mb-2 font-mono">
        <span class="mr-2">$</span>ls -la /links/
      </h1>
      <p class="text-[--color-text-dim] font-mono">
        Total: {allLinks.length} links
      </p>
      <div class="h-1 w-32 bg-[--color-terminal-green] mt-4"></div>
    </div>

    <!-- Search and Filters -->
    <div class="mb-8 space-y-4">
      <SearchBar placeholder="grep -r 'search...' /links/" class="max-w-2xl" />
      
      <!-- Tag Filter -->
      <div class="flex flex-wrap gap-2 items-center">
        <span class="text-[--color-text-dim] font-mono text-sm mr-2">Filter:</span>
        <button 
          data-filter="all" 
          class="tag-filter active px-3 py-1 text-sm font-mono border border-[--color-terminal-green]/50 hover:border-[--color-terminal-green] transition-colors"
        >
          All
        </button>
        {allTags.slice(0, 8).map((tag) => (
          <button 
            data-filter={tag}
            class="tag-filter px-3 py-1 text-sm font-mono border border-[--color-terminal-green]/50 hover:border-[--color-terminal-green] transition-colors"
          >
            #{tag}
          </button>
        ))}
        {allTags.length > 8 && (
          <a href="/tags" class="text-[--color-terminal-green] text-sm font-mono hover:underline">
            +{allTags.length - 8} more ‚Üí
          </a>
        )}
      </div>
    </div>

    <!-- Links Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="links-grid">
      {allLinks.map((link) => (
        <div 
          data-searchable={`${link.title} ${link.summary} ${link.tags.join(' ')} ${link.notes || ''}`}
          data-tags={link.tags.join(',')}
          class="link-item"
        >
          <LinkCard
            id={link.id}
            url={link.url}
            title={link.title}
            summary={link.summary}
            tags={link.tags}
            dateShared={link.dateShared}
            thumbnail={link.thumbnail}
          />
        </div>
      ))}
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden text-center py-16">
      <div class="text-6xl mb-4">üîç</div>
      <h3 class="text-xl font-mono text-[--color-terminal-green] mb-2">No results found</h3>
      <p class="text-[--color-text-dim]">Try adjusting your search or filters</p>
    </div>
  </section>
</BaseLayout>

<script>
  // Tag filter functionality
  const filterButtons = document.querySelectorAll('.tag-filter');
  const linkItems = document.querySelectorAll('.link-item');
  const emptyState = document.getElementById('empty-state');
  
  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      // Update active state
      filterButtons.forEach(btn => btn.classList.remove('active', 'bg-[--color-terminal-green]', 'text-[--color-bg]'));
      button.classList.add('active', 'bg-[--color-terminal-green]', 'text-[--color-bg]');
      
      const filter = button.getAttribute('data-filter');
      let visibleCount = 0;
      
      linkItems.forEach(item => {
        const element = item as HTMLElement;
        const tags = element.dataset.tags?.split(',') || [];
        
        if (filter === 'all' || tags.includes(filter || '')) {
          element.style.display = '';
          visibleCount++;
        } else {
          element.style.display = 'none';
        }
      });
      
      // Show/hide empty state
      if (emptyState) {
        emptyState.classList.toggle('hidden', visibleCount > 0);
      }
    });
  });
  
  // Listen for search events to show/hide empty state
  window.addEventListener('search', ((e: CustomEvent) => {
    const { count } = e.detail;
    if (emptyState) {
      emptyState.classList.toggle('hidden', count > 0);
    }
  }) as EventListener);
</script>

<style>
  .tag-filter.active {
    background-color: var(--color-terminal-green);
    color: var(--color-bg);
  }
</style>
