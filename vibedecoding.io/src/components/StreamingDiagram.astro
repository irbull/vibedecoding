---
interface Props {
  class?: string;
}
const { class: className } = Astro.props;
---

<div class:list={['streaming-diagram', className]}>
  <svg viewBox="0 0 800 500" class="w-full h-auto" role="img" aria-label="Streaming architecture diagram showing data flow from events through router to agents and materializer">
    <defs>
      <!-- Gradient for particles -->
      <radialGradient id="particleGlow" cx="50%" cy="50%" r="50%">
        <stop offset="0%" stop-color="#60a5fa" stop-opacity="1" />
        <stop offset="100%" stop-color="#3b82f6" stop-opacity="0.3" />
      </radialGradient>
      <radialGradient id="particleGlowGreen" cx="50%" cy="50%" r="50%">
        <stop offset="0%" stop-color="#34d399" stop-opacity="1" />
        <stop offset="100%" stop-color="#10b981" stop-opacity="0.3" />
      </radialGradient>
      <radialGradient id="particleGlowAmber" cx="50%" cy="50%" r="50%">
        <stop offset="0%" stop-color="#fbbf24" stop-opacity="1" />
        <stop offset="100%" stop-color="#f59e0b" stop-opacity="0.3" />
      </radialGradient>
    </defs>

    <!-- Background paths (the lines data flows along) -->
    <g class="paths" stroke="#374151" stroke-width="2" fill="none" opacity="0.3">
      <!-- events.raw to Router -->
      <path d="M 400,60 L 400,100" />
      <!-- Router to work topics -->
      <path d="M 400,160 L 400,200" />
      <path d="M 400,160 L 200,200" />
      <path d="M 400,160 L 600,200" />
      <!-- Work topics to agents -->
      <path d="M 200,260 L 200,300" />
      <path d="M 400,260 L 400,300" />
      <path d="M 600,260 L 600,300" />
      <!-- Agents to Materializer -->
      <path d="M 200,360 L 400,400" />
      <path d="M 400,360 L 400,400" />
      <path d="M 600,360 L 400,400" />
      <!-- Materializer to Database -->
      <path d="M 400,460 L 400,480" />
    </g>

    <!-- Nodes -->
    <g class="nodes">
      <!-- events.raw -->
      <g transform="translate(400, 40)">
        <rect x="-60" y="-20" width="120" height="40" rx="6" fill="#1e3a5f" stroke="#3b82f6" stroke-width="2" />
        <text x="0" y="5" text-anchor="middle" fill="#93c5fd" font-size="13" font-family="monospace">events.raw</text>
      </g>

      <!-- Router -->
      <g transform="translate(400, 130)">
        <rect x="-50" y="-20" width="100" height="40" rx="6" fill="#374151" stroke="#6b7280" stroke-width="2" />
        <text x="0" y="5" text-anchor="middle" fill="#d1d5db" font-size="13" font-weight="600">Router</text>
      </g>

      <!-- Work Topics -->
      <g transform="translate(200, 230)">
        <rect x="-55" y="-20" width="110" height="40" rx="6" fill="#064e3b" stroke="#10b981" stroke-width="2" />
        <text x="0" y="5" text-anchor="middle" fill="#6ee7b7" font-size="11" font-family="monospace">work.fetch</text>
      </g>
      <g transform="translate(400, 230)">
        <rect x="-55" y="-20" width="110" height="40" rx="6" fill="#064e3b" stroke="#10b981" stroke-width="2" />
        <text x="0" y="5" text-anchor="middle" fill="#6ee7b7" font-size="11" font-family="monospace">work.enrich</text>
      </g>
      <g transform="translate(600, 230)">
        <rect x="-55" y="-20" width="110" height="40" rx="6" fill="#064e3b" stroke="#10b981" stroke-width="2" />
        <text x="0" y="5" text-anchor="middle" fill="#6ee7b7" font-size="11" font-family="monospace">work.publish</text>
      </g>

      <!-- Agents -->
      <g transform="translate(200, 330)">
        <rect x="-45" y="-20" width="90" height="40" rx="6" fill="#78350f" stroke="#f59e0b" stroke-width="2" />
        <text x="0" y="5" text-anchor="middle" fill="#fcd34d" font-size="12" font-weight="600">Fetcher</text>
      </g>
      <g transform="translate(400, 330)">
        <rect x="-45" y="-20" width="90" height="40" rx="6" fill="#78350f" stroke="#f59e0b" stroke-width="2" />
        <text x="0" y="5" text-anchor="middle" fill="#fcd34d" font-size="12" font-weight="600">Enricher</text>
      </g>
      <g transform="translate(600, 330)">
        <rect x="-45" y="-20" width="90" height="40" rx="6" fill="#78350f" stroke="#f59e0b" stroke-width="2" />
        <text x="0" y="5" text-anchor="middle" fill="#fcd34d" font-size="12" font-weight="600">Publisher</text>
      </g>

      <!-- Materializer -->
      <g transform="translate(400, 430)">
        <rect x="-60" y="-20" width="120" height="40" rx="6" fill="#374151" stroke="#6b7280" stroke-width="2" />
        <text x="0" y="5" text-anchor="middle" fill="#d1d5db" font-size="13" font-weight="600">Materializer</text>
      </g>

      <!-- Database -->
      <g transform="translate(400, 485)">
        <ellipse cx="0" cy="0" rx="40" ry="12" fill="#1f2937" stroke="#4b5563" stroke-width="2" />
        <rect x="-40" y="0" width="80" height="20" fill="#1f2937" stroke="none" />
        <ellipse cx="0" cy="20" rx="40" ry="12" fill="#1f2937" stroke="#4b5563" stroke-width="2" />
        <line x1="-40" y1="0" x2="-40" y2="20" stroke="#4b5563" stroke-width="2" />
        <line x1="40" y1="0" x2="40" y2="20" stroke="#4b5563" stroke-width="2" />
        <text x="0" y="32" text-anchor="middle" fill="#9ca3af" font-size="10">Postgres</text>
      </g>
    </g>

    <!-- Animated Particles -->
    <g class="particles">
      <!-- events.raw to Router particles -->
      <circle class="particle p1" r="4" fill="url(#particleGlow)" />
      <circle class="particle p1" r="4" fill="url(#particleGlow)" style="animation-delay: -0.8s" />
      <circle class="particle p1" r="4" fill="url(#particleGlow)" style="animation-delay: -1.6s" />

      <!-- Router to work.fetch particles -->
      <circle class="particle p2a" r="4" fill="url(#particleGlowGreen)" />
      <circle class="particle p2a" r="4" fill="url(#particleGlowGreen)" style="animation-delay: -1s" />

      <!-- Router to work.enrich particles -->
      <circle class="particle p2b" r="4" fill="url(#particleGlowGreen)" />
      <circle class="particle p2b" r="4" fill="url(#particleGlowGreen)" style="animation-delay: -1s" />

      <!-- Router to work.publish particles -->
      <circle class="particle p2c" r="4" fill="url(#particleGlowGreen)" />
      <circle class="particle p2c" r="4" fill="url(#particleGlowGreen)" style="animation-delay: -1s" />

      <!-- work.fetch to Fetcher particles -->
      <circle class="particle p3a" r="4" fill="url(#particleGlowAmber)" />
      <circle class="particle p3a" r="4" fill="url(#particleGlowAmber)" style="animation-delay: -0.7s" />

      <!-- work.enrich to Enricher particles -->
      <circle class="particle p3b" r="4" fill="url(#particleGlowAmber)" />
      <circle class="particle p3b" r="4" fill="url(#particleGlowAmber)" style="animation-delay: -0.7s" />

      <!-- work.publish to Publisher particles -->
      <circle class="particle p3c" r="4" fill="url(#particleGlowAmber)" />
      <circle class="particle p3c" r="4" fill="url(#particleGlowAmber)" style="animation-delay: -0.7s" />

      <!-- Fetcher to Materializer particles -->
      <circle class="particle p4a" r="4" fill="url(#particleGlow)" />
      <circle class="particle p4a" r="4" fill="url(#particleGlow)" style="animation-delay: -1.2s" />

      <!-- Enricher to Materializer particles -->
      <circle class="particle p4b" r="4" fill="url(#particleGlow)" />
      <circle class="particle p4b" r="4" fill="url(#particleGlow)" style="animation-delay: -1.2s" />

      <!-- Publisher to Materializer particles -->
      <circle class="particle p4c" r="4" fill="url(#particleGlow)" />
      <circle class="particle p4c" r="4" fill="url(#particleGlow)" style="animation-delay: -1.2s" />

      <!-- Materializer to Database particles -->
      <circle class="particle p5" r="3" fill="url(#particleGlow)" />
      <circle class="particle p5" r="3" fill="url(#particleGlow)" style="animation-delay: -0.5s" />
    </g>
  </svg>
</div>

<style>
  .streaming-diagram {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    border-radius: 12px;
    padding: 1.5rem;
    overflow: hidden;
  }

  @keyframes flowPath {
    0% {
      offset-distance: 0%;
      opacity: 0;
    }
    5% {
      opacity: 1;
    }
    95% {
      opacity: 1;
    }
    100% {
      offset-distance: 100%;
      opacity: 0;
    }
  }

  .particle {
    animation: flowPath 2s ease-in-out infinite;
  }

  /* events.raw to Router */
  .p1 {
    offset-path: path('M 400,60 L 400,110');
    animation-duration: 1.2s;
  }

  /* Router to work topics */
  .p2a {
    offset-path: path('M 400,150 C 400,175 200,175 200,210');
    animation-duration: 1.5s;
  }
  .p2b {
    offset-path: path('M 400,150 L 400,210');
    animation-duration: 1.2s;
  }
  .p2c {
    offset-path: path('M 400,150 C 400,175 600,175 600,210');
    animation-duration: 1.5s;
  }

  /* Work topics to agents */
  .p3a {
    offset-path: path('M 200,250 L 200,310');
    animation-duration: 1.2s;
  }
  .p3b {
    offset-path: path('M 400,250 L 400,310');
    animation-duration: 1.2s;
  }
  .p3c {
    offset-path: path('M 600,250 L 600,310');
    animation-duration: 1.2s;
  }

  /* Agents to Materializer */
  .p4a {
    offset-path: path('M 200,350 C 200,380 400,380 400,410');
    animation-duration: 1.8s;
  }
  .p4b {
    offset-path: path('M 400,350 L 400,410');
    animation-duration: 1.2s;
  }
  .p4c {
    offset-path: path('M 600,350 C 600,380 400,380 400,410');
    animation-duration: 1.8s;
  }

  /* Materializer to Database */
  .p5 {
    offset-path: path('M 400,450 L 400,485');
    animation-duration: 1s;
  }

  /* Add subtle glow effect to nodes on hover */
  .nodes g:hover rect,
  .nodes g:hover ellipse {
    filter: drop-shadow(0 0 8px currentColor);
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    .particle {
      animation: none;
      opacity: 0;
    }
  }
</style>
