---
import BaseLayout from './BaseLayout.astro';
import SeriesPill from '../components/SeriesPill.astro';
import TableOfContents from '../components/TableOfContents.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

interface Props {
  guide: CollectionEntry<'guide'>;
  headings: { depth: number; slug: string; text: string }[];
}

const { guide, headings } = Astro.props;
const { title, description, series, part, canonicalUrl } = guide.data;

// Get series guides for navigation
let seriesGuides: CollectionEntry<'guide'>[] = [];
let currentIndex = -1;
let totalParts = 0;

if (series) {
  const allGuides = await getCollection('guide');
  seriesGuides = allGuides
    .filter((g: CollectionEntry<'guide'>) => g.data.series === series && g.data.status === 'published')
    .sort((a: CollectionEntry<'guide'>, b: CollectionEntry<'guide'>) => (a.data.part || 0) - (b.data.part || 0));
  totalParts = seriesGuides.length;
  currentIndex = seriesGuides.findIndex((g) => g.slug === guide.slug);
}

const prevGuide = currentIndex > 0 ? seriesGuides[currentIndex - 1] : null;
const nextGuide = currentIndex < seriesGuides.length - 1 ? seriesGuides[currentIndex + 1] : null;
---

<BaseLayout
  title={title}
  description={description}
  canonicalUrl={canonicalUrl}
  ogType="article"
>
  <article class="max-w-4xl mx-auto px-4 sm:px-6 py-12">
    <div class="lg:grid lg:grid-cols-[1fr_200px] lg:gap-12">
      <!-- Main content -->
      <div class="min-w-0">
        <!-- Header -->
        <header class="mb-8">
          {series && part !== undefined && (
            <div class="mb-4">
              <SeriesPill series={series} part={part} totalParts={totalParts} />
            </div>
          )}

          <h1 class="text-3xl sm:text-4xl font-bold text-[var(--color-text)] leading-tight">
            {title}
          </h1>
        </header>

        <!-- Guide content -->
        <div class="prose prose-neutral max-w-none">
          <slot />
        </div>

        <!-- Series navigation -->
        {(prevGuide || nextGuide) && (
          <nav class="mt-12 pt-8 border-t border-[var(--color-border)]">
            <div class="grid gap-4 sm:grid-cols-2">
              {prevGuide && (
                <a
                  href={`/guide/${prevGuide.slug}`}
                  class="group block p-4 border border-[var(--color-border)] rounded-lg hover:border-accent-500 transition-colors"
                >
                  <span class="text-xs text-[var(--color-text-muted)] uppercase tracking-wide">
                    Previous
                  </span>
                  <span class="block mt-1 font-medium text-[var(--color-text)] group-hover:text-[var(--color-accent)] transition-colors">
                    {prevGuide.data.title}
                  </span>
                </a>
              )}
              {nextGuide && (
                <a
                  href={`/guide/${nextGuide.slug}`}
                  class:list={[
                    'group block p-4 border border-[var(--color-border)] rounded-lg hover:border-accent-500 transition-colors text-right',
                    !prevGuide && 'sm:col-start-2',
                  ]}
                >
                  <span class="text-xs text-[var(--color-text-muted)] uppercase tracking-wide">
                    Next
                  </span>
                  <span class="block mt-1 font-medium text-[var(--color-text)] group-hover:text-[var(--color-accent)] transition-colors">
                    {nextGuide.data.title}
                  </span>
                </a>
              )}
            </div>
          </nav>
        )}
      </div>

      <!-- TOC sidebar (desktop) -->
      <aside class="hidden lg:block">
        <TableOfContents headings={headings} />
      </aside>
    </div>
  </article>
</BaseLayout>
